<html>
<head>
	<title>Pronostico de viento Rio de la Plata : GeoJSON + Leaflet</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
	<link rel="stylesheet" href="leaflet.css" />
	<link rel="stylesheet" href="leaflet.label.css" />
	<script src="leaflet.js"></script>
	<script src="leaflet.label.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		#map {
			width: 700px;
			height: 400px;
		}
		.estilo-label {
			//position: absolute;
			width:90px;
			border: 1px;
			height: 25px;
			font-size:10px;
		}
	</style>

	
</head>
<body>

Tomando los Datos Abiertos de el <a href="https://www.smn.gob.ar/descarga-de-datos">Servicio Meteorologico Nacional</a>
y filtrandolos de acuerdo a lo que comparti <a href="https://serverlinux.blogspot.com/2021/04/d3-observable-notas-post-meeting-de-d3.html">aca</a>
los combine con un mapa y usando la columna de direccion del viento,decodificado segun el angulo de origen en la direccion.<br />
<table>
<tr><td>
<div id='map'></div>
</td><td>
<img src="https://lh4.googleusercontent.com/proxy/ZTg8ZfYAE0kzZXLZ1pt3WQY-Ma0FUoz9jQXI3cUDh3YwAhpHlJfbz5lj25YpPeXgdU70n40MZw1S1QgCGWiudgkKsRkntosJgYukTN-crc8iXN3YgVlXuwIkpqu7j_vYVtD4=s0-d" />
</td></tr></table>

<script>
	var center = [-34.472, -58.484];
	var WindIcon = L.Icon.extend({
	options: {
	iconSize:     [20, 20],
	labelAnchor: [3, 0]
	}
	});
	var Viento_e = new WindIcon({iconUrl: 'v-e.png'});
	var Viento_o = new WindIcon({iconUrl: 'v-o.png'});
	var Viento_s = new WindIcon({iconUrl: 'v-s.png'});
	var Viento_n = new WindIcon({iconUrl: 'v-n.png'});
	var Viento_ne = new WindIcon({iconUrl: 'v-ne.png'});
	var Viento_no = new WindIcon({iconUrl: 'v-no.png'});
	var Viento_se = new WindIcon({iconUrl: 'v-se.png'});

	var map = L.map('map').setView(center, 15);
	var osmUrl = ' http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
	var osmTiles = new L.TileLayer(osmUrl, {maxZoom: 18});
	L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
			'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox/light-v9',
		tileSize: 512,
		zoomOffset: -1
	}).addTo(map);


	//L.marker(center).addTo(map);
	var pointA = L.latLng(-34.4722, -58.480);
	var pointB = L.latLng(-34.473, -58.483);
	var pointC = L.latLng(-34.474, -58.480);
	var pointList = [pointA, pointB, pointC, pointA];
	// Jugando con lineas
	//L.polyline(pointList).addTo(map);

	var cruz_punto_x = -58.489;
	var cruz_punto_y = -34.465;
	var imageBounds = [ [ cruz_punto_y, cruz_punto_x ] , [ (cruz_punto_y-0.0035), (cruz_punto_x-0.004) ] ];
	L.imageOverlay('768px-Rosa_de_los_vientos.svg.png', imageBounds).addTo(map);

	var initial_point_y = -34.469;
	var initial_point_x = -58.486;

	// Algo de jquery / ajax viene tan bien:
	$(document).ready(function() {
		$.ajax({
			type: "GET",
			url: "https://raw.githubusercontent.com/wlamagna/viz1/master/clima/BUENOS_AIRES.csv",
			dataType: "text",
			success: function(data) { leerDatosDelTiempo(data, map);}
		});
	});

	// Leer el CSV y extraer la direccion pronosticada:
	function leerDatosDelTiempo(allText, map) {
		var record_num = 5;  // elementos por columna
		var allTextLines = allText.split(/\r\n|\n/);
		var count = 1;
		var initial_point_y = -34.469;
		var initial_point_x = -58.49;
		var texto_agregar = "";
		var icono = Viento_ne;
		var daynum_tmp = 0;
		var ancho_primer_dato = 0;
		while (count <= (allTextLines.length-2)) {
			var entries = allTextLines[count].split(',');
			// Agregado como marcador permite adjuntar un texto:
			if ((entries[2] >= 30) && (entries[2] < 70)) {
				texto_agregar = 'NE:';
				icono = Viento_ne;	
			}
			if ((entries[2] >=70) && (entries[2] < 110)) {
				texto_agregar = 'E:';
				icono = Viento_e;	
			}
			if ((entries[2] >=110) && (entries[2] < 150)) {
				texto_agregar = 'SE:';
				icono = Viento_se;
			}
			if ((entries[2] >= 150 ) && (entries[2] < 215)) {
				texto_agregar = 'S:';
				icono = Viento_s;	
			}
			if ((entries[2] >= 215 ) && (entries[2] < 295)) {
				texto_agregar = 'O:';
				icono = Viento_o;
			}

			if ((entries[2] >= 295 ) && (entries[2] < 340)) {
				texto_agregar = 'NO:';
				icono = Viento_no;
			}
			if ((entries[2] >= 340 ) || (entries[2] < 30)) {
				texto_agregar = 'N:';
				icono = Viento_n;
			}

			var fecha_y_hora = entries[0].split(" ");
			var daynum = entries[0].split("/");
			if (!(daynum_tmp == daynum[0])) {
				daynum_tmp = daynum[0];
				initial_point_y -= 0.0009;
				initial_point_x = -58.495;
				ancho_primer_dato = 0;
				texto_agregar = texto_agregar + entries[0];
			} else {
				texto_agregar = texto_agregar + fecha_y_hora[1];
				if (ancho_primer_dato == 0) {
					initial_point_x += 0.005;
					ancho_primer_dato = 1;
				} else {
					initial_point_x += 0.003;
				}
			}
			L.marker([initial_point_y, initial_point_x], {draggable: true, icon: icono })
			.bindLabel(texto_agregar, { noHide: true,className: "estilo-label" })
			.addTo(map);
			texto_agregar = "";
			//console.log(entries[2]);
			count = count + 1;
		}
		//console.log(allTextLines);
	}
</script>

</body>
</html>
